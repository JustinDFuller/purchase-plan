kind: pipeline
name: default

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src/github.com/justindfuller/purchase-plan

steps:
  - name: setup
    image: bash
    environment:
      GOOGLE_APPLICATION_CREDENTIALS:
        from_secret: TERRAFORM_CREDENTIALS_PURCHASE_PLAN_CENTRAL_DEV
    commands:
      - ./scripts/setup

  - name: backend
    image: nytimes/golang-gcloud-sdk:latest
    commands:
      - ./scripts/setup
      - cd backend
      # - make test
      - make build

  - name: frontend
    image: node
    commands:
      - cd frontend
      - npm ci
      - npm run build
      - mkdir ../backend/frontend/
      - cp -r ./build/ ../backend/frontend/

  - name: terraform-remote
    image: hashicorp/terraform:light
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: ../../application_default_credentials.json
    commands:
      - cd ./terraform/remote
      - terraform init
      - terraform fmt -check
      - terraform apply -auto-approve
    depends_on:
      - frontend
      - backend
      - setup

  - name: terraform-dev
    image: hashicorp/terraform:light
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: ../../application_default_credentials.json
    commands:
      - cd ./terraform/dev
      - terraform init
      - terraform fmt -check
      - terraform apply -auto-approve
    depends_on:
      - terraform-remote

  - name: deploy-dev
    image: nytimes/drone-gae
    environment:
      GAE_CREDENTIALS:
        from_secret: DRONE_CREDENTIALS_DEV_CENTRAL
    settings:
      action: deploy
      project: purchase-plan-dev
      dir: backend/cmd/server
      app_file: app.yaml
      max_versions: 10
    when:
      event: push
      branch: [main]
    depends_on:
      - frontend
      - backend
      - terraform-dev
